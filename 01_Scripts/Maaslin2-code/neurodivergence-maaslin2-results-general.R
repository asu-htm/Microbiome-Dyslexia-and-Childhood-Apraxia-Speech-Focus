####################################
#
#     Maaslin2 script
#     Created by Sterling Wright 
#     March 6th, 2025
#
####################################

# set working directory to where your files are located 
setwd("/Users/aydenhall/Documents/Neurological Microbiome Data for Filtering/Maaslin2 Analysis/")

# Install Maaslin2 if you need to
# devtools::install_github("biobakery/Maaslin2")

library("devtools")
library(Maaslin2)

# Import data

# Load the data
# You will need to ensure that the csv file is set up so that the commented lines are removed
# data will be the species-level table for each one generated by a different database
# metadata file should be the same 
# additional help can be found here: https://huttenhower.sph.harvard.edu/maaslin/

data <- read.csv("filtered-species-table-GSR-species-table.csv", header = TRUE, sep = ",", row.names = 1)
metadata<- read.csv("Metadata_updated_25FEB25.csv")
rownames(metadata) <- metadata$SampleID 

# Ensure that phenotype is set as a factor
metadata$Phenotype <- 
  factor(metadata$Phenotype, levels = c('Typical', 'Apraxia_of_speech', 'Dyslexia'))

# set seed 
set.seed(1)

# You will need to create a directory for each database 
fit_data = Maaslin2(
  input_data = data, 
  input_metadata = metadata, 
  output = "/Users/aydenhall/Documents/Neurological Microbiome Data for Filtering/Maaslin2 Analysis/GSR Maaslin2 Analysis", 
  fixed_effects = c("Phenotype"),
  max_significance = 0.1,
  analysis_method = "LM")


